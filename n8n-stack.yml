AWSTemplateFormatVersion: 2010-09-09
Description: Create AWS infra to host N8N env

Parameters:
  DomainName:
    Type: String
    Description: My domain
    Default: dom-beard.com

  Subdomain:
    Type: String
    Description: My domain
    Default: n8n

  Timezone:
    Type: String 
    Description: Timezone
    Default: Europe/London

  SSLEmail:
    Type: String 
    Description: AWS Account which hold SSL Cert
    Default: dommo1998@gmail.com

Resources:
  EC2CFNDOCKER:
    Type: AWS::EC2::Instance
    Properties: 
      ImageId: ami-0532be01f26a3de55
      InstanceType: t2.micro
      SecurityGroupIds: 
        - !Ref CFNDOCKERSECGROUP
      Tags:
        - Key: Name
          Value: n8n-traefik
      UserData:
        Fn::Base64: 
          Fn::Sub: |
            #!/bin/bash
            set -e
            
            yum install -y docker
            systemctl start docker
            systemctl enable docker
            usermod -aG docker ec2-user
            
            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose 
            
            mkdir -p /home/ec2-user/n8n
            cd /home/ec2-user/n8n
            
            cat > docker-compose.yml <<'EOF'
            services:
              traefik:
                image: "traefik"
                restart: always
                command:
                  - "--api.insecure=true"
                  - "--providers.docker=true"
                  - "--providers.docker.exposedbydefault=false"
                  - "--entrypoints.web.address=:80"
                  - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
                  - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
                  - "--entrypoints.websecure.address=:443"
                  - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
                  - "--certificatesresolvers.mytlschallenge.acme.email=${!SSL_EMAIL}"
                  - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - traefik_data:/letsencrypt
                  - /var/run/docker.sock:/var/run/docker.sock:ro
              n8n:
                image: docker.n8n.io/n8nio/n8n
                restart: always
                ports:
                  - "127.0.0.1:5678:5678"
                labels:
                  - traefik.enable=true
                  - traefik.http.routers.n8n.rule=Host(`${!SUBDOMAIN}.${!DOMAIN_NAME}`)
                  - traefik.http.routers.n8n.tls=true
                  - traefik.http.routers.n8n.entrypoints=web,websecure
                  - traefik.http.routers.n8n.tls.certresolver=mytlschallenge
                  - traefik.http.middlewares.n8n.headers.SSLRedirect=true
                  - traefik.http.middlewares.n8n.headers.STSSeconds=315360000
                  - traefik.http.middlewares.n8n.headers.browserXSSFilter=true
                  - traefik.http.middlewares.n8n.headers.contentTypeNosniff=true
                  - traefik.http.middlewares.n8n.headers.forceSTSHeader=true
                  - traefik.http.middlewares.n8n.headers.SSLHost=${!DOMAIN_NAME}
                  - traefik.http.middlewares.n8n.headers.STSIncludeSubdomains=true
                  - traefik.http.middlewares.n8n.headers.STSPreload=true
                  - traefik.http.routers.n8n.middlewares=n8n@docker
                environment:
                  - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
                  - N8N_HOST=${!SUBDOMAIN}.${!DOMAIN_NAME}
                  - N8N_PORT=5678
                  - N8N_PROTOCOL=https
                  - N8N_RUNNERS_ENABLED=true
                  - NODE_ENV=production
                  - WEBHOOK_URL=https://${!SUBDOMAIN}.${!DOMAIN_NAME}/
                  - GENERIC_TIMEZONE=${!GENERIC_TIMEZONE}
                  - TZ=${!GENERIC_TIMEZONE}
                volumes:
                  - n8n_data:/home/node/.n8n
                  - ./local-files:/files
            volumes:
              n8n_data:
              traefik_data:
            EOF
            
            cat > .env <<EOF
            SSL_EMAIL=${SSLEmail}
            SUBDOMAIN=${Subdomain}
            DOMAIN_NAME=${DomainName}
            GENERIC_TIMEZONE=${Timezone}
            EOF
            
            mkdir -p /home/ec2-user/n8n/local-files

            chown -R ec2-user:ec2-user /home/ec2-user/n8n
            
            docker-compose up -d
            
            echo "n8n deployment completed successfully" > /var/log/n8n-deployment.log

  
  CFNDOCKERSECGROUP:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Port 80, 443 and SSH (temp)
      SecurityGroupIngress:
        - IpProtocol: tcp 
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp 
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp 
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
  
  EIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: eipalloc-0c4ba081c74e32bc7 
      InstanceId: !Ref EC2CFNDOCKER



